<!DOCTYPE html>
<html id="all">

<head>
	<meta charset="utf-8">

















<link rel="shortcut icon" href="/pic/favicon.ico">
	<title>Paradoxless | Blogs</title>
	
<link rel="stylesheet" href="/css/main.css">

	
<link rel="stylesheet" href="/css/font.css">

	
<link rel="stylesheet" href="/lib/highlight/rainbow.min.css">

<meta name="generator" content="Hexo 5.4.2"></head>
	
<script src="/lib/highlight/highlight.min.js"></script>

	
<script src="/lib/highlight/highlightjs-line-numbers.js"></script>

	
<script src="/lib/jquery.js"></script>

	
<script src="/lib/jquery.pjax.js"></script>

	
<script src="/js/main.js"></script>

<body id="lybody">
	<div id="head">
	<a id="pLogo" href="/"><img alt="P" src="/pic/logo.svg"></a>
	<div id="urlText">aradoxskin.</div>
	<a id="githubLogo" href="https://github.com/paradoxskin" target="_blank"><img alt="github" src="/pic/github.svg"></a>
	<div id="urlText">.io</div>
	<div id="sucklessText">- simple is best</div>
	<div id="clear"></div>
</div>

	<hr id="hidden">
	<script>
	//if(localStorage.getItem('bgs')==null){
		localStorage['bgs']='comp'

			localStorage.setItem('bgs[num]','25');

			localStorage.setItem('bgs[pic1]','/pic/wp/01.jpg');

			localStorage.setItem('bgs[pic2]','/pic/wp/02.jpg');

			localStorage.setItem('bgs[pic3]','/pic/wp/03.jpg');

			localStorage.setItem('bgs[pic4]','/pic/wp/04.jpg');

			localStorage.setItem('bgs[pic5]','/pic/wp/05.jpg');

			localStorage.setItem('bgs[pic6]','/pic/wp/06.jpg');

			localStorage.setItem('bgs[pic7]','/pic/wp/07.jpg');

			localStorage.setItem('bgs[pic8]','/pic/wp/08.jpg');

			localStorage.setItem('bgs[pic9]','/pic/wp/09.jpg');

			localStorage.setItem('bgs[pic10]','/pic/wp/10.jpg');

			localStorage.setItem('bgs[pic11]','/pic/wp/11.jpg');

			localStorage.setItem('bgs[pic12]','/pic/wp/12.jpg');

			localStorage.setItem('bgs[pic13]','/pic/wp/13.png');

			localStorage.setItem('bgs[pic14]','/pic/wp/14.png');

			localStorage.setItem('bgs[pic15]','/pic/wp/15.png');

			localStorage.setItem('bgs[pic16]','/pic/wp/16.jpg');

			localStorage.setItem('bgs[pic17]','/pic/wp/17.jpg');

			localStorage.setItem('bgs[pic18]','/pic/wp/18.jpg');

			localStorage.setItem('bgs[pic19]','/pic/wp/19.jpg');

			localStorage.setItem('bgs[pic20]','/pic/wp/20.jpg');

			localStorage.setItem('bgs[pic21]','/pic/wp/21.png');

			localStorage.setItem('bgs[pic22]','/pic/wp/22.jpg');

			localStorage.setItem('bgs[pic23]','/pic/wp/23.png');

			localStorage.setItem('bgs[pic24]','/pic/wp/24.jpg');

			localStorage.setItem('bgs[pic25]','/pic/wp/25.jpg');

		if(localStorage.getItem('now')==null){
			localStorage.setItem('now','pic22');
		}
	//}
</script>

<div id="nav">
	<ul>
		<li><button id="cgBg" onclick="randomSwitch()">O</button><button id="clBg" onclick="noBg()">_</button></li>

		<iframe id="music-player" frameborder="no" border="0" marginwidth="0" marginheight="0" width=330 height=110 src="//music.163.com/outchain/player?type=0&id=7669623816&auto=0&height=90"></iframe>

		<button id="nav-hide" onclick="hideMenu()">◤</button>

		<span id="clear"></span>
	</ul>
</div>
<button id="nav-show" onclick="showMenu()">◢</button>

<span id="pup">
	<div id="menu">
	
	
		
			<b><a href="/" class="menu-item-link" id="in">Home</a></b>
		
	
		
			<b><a data-pjax="#main" href="/blogs" class="menu-item-link-selected" id="in">Blogs</a></b>
		
	
		
			<b><a href="/archives" class="menu-item-link" id="in">Archives</a></b>
		
	
		
			<b><a href="/about" class="menu-item-link" id="in">who@mi</a></b>
		
	
		
			<b><a href="/links" class="menu-item-link" id="in">Links</a></b>
		
	
	<div id="outlink">
	
		<a href="https://www.lexaloffle.com/pico-8.php" class="menu-item-link" id="out" target="_blank">pico-8</a>
	
		<a href="https://suckless.org/" class="menu-item-link" id="out" target="_blank">suckless</a>
	
	</div>
</div>

	<div id="main">
		<div id="post">

	<b><div id="start-title">JS 闭包</div></b>

	
	<center><b><span id="start-date">start at 2023/02/08.</span></b></center>
	

    <h2 id="闭包"><a href="#闭包" class="headerlink" title="闭包"></a>闭包</h2><blockquote>
<p>我在写信息管理系统的前端页面，决定使用 jquery 来实现前后端分离，具体的方法是在前端 script 里面使用 ajax 来异步带着数据访问后端，然后根据后端返回的 json 来渲染前端的页面，至于我为什么会遇到闭包这个东西呢？听我慢慢道来 …</p>
<span id="more"></span>
</blockquote>
<p>当时写的代码是传给后端 token，然后后端根据 token 对应的用户的权限返回要加载的选项卡，后端功能很好实现，直接这么写就行了</p>
<pre><code class="go">token, isOk := c.GetPostForm(&quot;token&quot;)
if !isOk &#123;
    c.JSON(200, map[string]interface&#123;&#125;&#123;
        &quot;msg&quot;: &quot;fail&quot;,
    &#125;)
    return
&#125;
if !service.CheckToken(&amp;token) &#123;
    c.JSON(200, map[string]interface&#123;&#125;&#123;
        &quot;msg&quot;: &quot;fail&quot;,
    &#125;)
    return
&#125;
if service.CheckRoot(&amp;token) &#123;
    c.JSON(200, map[string]interface&#123;&#125;&#123;
        &quot;msg&quot;: &quot;ok&quot;,
        // TODO
    &#125;)
    return
&#125;
infoBacks := []pojo.InfoBack&#123;&#123;
    ButtonId: &quot;info&quot;,
    ObjUrl: &quot;/info&quot;,
    ButtonName: &quot;个人信息&quot;,
&#125;, &#123;
    ButtonId: &quot;room&quot;,
    ObjUrl: &quot;/room&quot;,
    ButtonName: &quot;寝室&quot;,
&#125;, &#123;
    ButtonId: &quot;clean&quot;,
    ObjUrl: &quot;/clean&quot;,
    ButtonName: &quot;卫生检查&quot;,
&#125;, &#123;
    ButtonId: &quot;break&quot;,
    ObjUrl: &quot;/break&quot;,
    ButtonName: &quot;报修&quot;,
&#125;, &#123;
    ButtonId: &quot;lost&quot;,
    ObjUrl: &quot;/lost&quot;,
    ButtonName: &quot;失物招领&quot;,
&#125;,
                            &#125;
c.JSON(200, map[string]interface&#123;&#125;&#123;
    &quot;msg&quot;: &quot;ok&quot;,
    &quot;infos&quot;: infoBacks,
&#125;)
</code></pre>
<p>实现接口之后我就把视线转到前端了，先 F12 里的 console 里测试了下，可以接收到 json 数据，然后就开始写 js 了，大致思路的根据传回的数据，遍历所有元素然后创建 li 标签加按钮，最后把创建出来的按钮绑定上 click 事件的函数</p>
<p>初版代码是这样的</p>
<pre><code class="html">&lt;script charset=&quot;utf-8&quot;&gt;
    $(function() &#123;
        $(&quot;#quit&quot;).click(function() &#123;
            var token = localStorage.getItem(&quot;token&quot;);
            localStorage.removeItem(&quot;token&quot;);
            var tks=&#123;&quot;token&quot;:token&#125;
            $.post(
                &quot;/quit&quot;,
                tks,
                function() &#123;
                    location.assign(&quot;/login&quot;);
                &#125;
            );
        &#125;);
        var token = localStorage.getItem(&quot;token&quot;);
        $.post(
            &quot;/index&quot;,
            &#123;&quot;token&quot;: token&#125;,
            function(data) &#123;
                var indexs = data
                for(var i = 0; i &lt; data.infos.length; i++) &#123;
                    $(&quot;#menu&quot;).append(&quot;&lt;li class=\&quot;nav-item\&quot;&gt;&lt;button class=\&quot;my-2 btn btn-secondary btn-block w-100\&quot; type=\&quot;button\&quot; id=\&quot;&quot; + data.infos[i].button_id + &quot;\&quot;&gt;&quot; + data.infos[i].button_name + &quot;&lt;/button&gt;&lt;/li&gt;&quot;);
                    $(&quot;#&quot; + data.infos[i].button_id).click(function() &#123;
                        $.get(
                            indexs.infos[i].obj_url,
                            function() &#123;
                                console.log(&quot;6&quot;)
                            &#125;
                        )
                    &#125;);
                &#125;
                // TODO
            &#125;
        );
    &#125;);
&lt;/script&gt;
</code></pre>
<p>既然是初版代码，那必然是有问题的，运行结果是标签渲染出来了，但是按钮按下去无事发生，console 里没显示 6，后端的日志也没有显示 404 的 get 请求（那些端口我都没写好</p>
<p>可喜可贺的是我在 console 里仔细看了下发现了在按下按钮之后他报错了，说<code>indexs.infos[i] is undefined</code> ，然后我大概知道了是怎么一回事，绑定函数的过程不包括执行，所以再次运行的时候它是独立出来运行的，这时候 i 就不见了，所以就报错了</p>
<p>那么怎么解决这个问题呢？凭我的经验肯定不能解决这种问题，借助了强大的搜索引擎，我找到了和我遇到类似问题的人 <a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_38712081/article/details/81665379">🔗</a></p>
<p>下面是能够 work 的代码</p>
<pre><code class="html">&lt;script&gt;
function(data) &#123;
    var indexs = data;
    for(var i = 0; i &lt; data.infos.length; i++) &#123;
        $(&quot;#menu&quot;).append(&quot;&lt;li class=\&quot;nav-item\&quot;&gt;&lt;button class=\&quot;my-2 btn btn-secondary btn-block w-100\&quot; type=\&quot;button\&quot; id=\&quot;&quot; + data.infos[i].button_id + &quot;\&quot;&gt;&quot; + data.infos[i].button_name + &quot;&lt;/button&gt;&lt;/li&gt;&quot;);
        (function(i) &#123;
        $(&quot;#&quot; + data.infos[i].button_id).click(function() &#123;
            $.get(
                indexs.infos[i].obj_url,
                function() &#123;
                    console.log(&quot;6&quot;)
                &#125;
            )
        &#125;);&#125;)(i)
    &#125;
&#125;
&lt;/script&gt;
</code></pre>
<blockquote>
<p>一个人同时写前后端真的挺累的，不过成就感倒是有的，web 也就这回事</p>
</blockquote>


	<b><span id="post-date">2023/02/08</span></b>
	<div id="tags">
		<ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%89%8D%E7%AB%AF/" rel="tag"># 前端</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%9D%82%E8%B0%88/" rel="tag"># 杂谈</a></li></ul>
	</div>

	<div id="clear"></div>
</div>
<center><a class="gobk" href="javascript:;" onclick="Gobk()">&gt CLICK TO back &lt</a><center>
<div id="cart">
	<button id="cart-hide" onclick="cartCg()">◀</button>
</div>
<script>
	if(history.state==null){
		var tmpa=document.getElementsByClassName("gobk")[0];
		tmpa.innerHTML="> CLICK TO land <";
	}
	showAIndex();
</script>

	</div>
	<script>
		hljs.highlightAll();
		hljs.initLineNumbersOnLoad();
	</script>
</span>
	<hr id="hidden">
	

	<script>
		hljs.highlightAll();
		hljs.initLineNumbersOnLoad();
		initBg();
		$(document).pjax('a','#pup',{fragment:'#pup',timeout: 8000});
	</script>
</body>
</html>
