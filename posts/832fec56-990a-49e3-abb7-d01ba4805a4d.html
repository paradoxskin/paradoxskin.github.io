<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>博客支持plantuml</title>
    <link rel="stylesheet" href="/res/css/style.css">
</head>
<body>
<nav class="main-nav">
  <ul>
    <li><a href="/blog">blog</a></li>
    <li><a href="/archive">archive</a></li>
    <li><a href="/design">design</a></li>
    <li><a href="/rss">rss</a></li>
  </ul>
</nav>
<h2>Q</h2>
<p>破公司的设计文档终于决定要从word改为markdown了。其中画UML的工具是<code>plantuml</code>，写个工具让我能够在linux侧编辑，windows侧看到效果。同时博客这边也支持一下这个功能，后面应该能掌握这个工具。</p>
<h2>~</h2>
<p>官方提供的转换工具是一个<a href="https://plantuml.com/zh/download">jar包</a>，随便选择一个开源协议下载。</p>
<blockquote>
<p>这个网站会弹窗通知权限，通过浏览器给你推送广告了。如果点了同意，记得在设置里取消。</p>
</blockquote>
<p>演示一下如何使用，比如说以下的例子：</p>
<pre><code>@startuml
start
if (legel) then (T)
    :process;
else
    :report error;
endif
end
@enduml
</code></pre>
<p>保存进一个文件里，然后使用命令行生成图片：</p>
<pre><code>java -jar puml.jar tmp.txt --svg

# 使用流输入
cat tmp.txt |java -jar puml.jar --svg --pipe &gt; tmp.svg

java -jar puml.jar --svg --pipe &gt; tmp.svg &lt;&lt;EOF
@startuml
start
if (legel) then (T)
    :process;
else
    :report error;
endif
end
@enduml
EOF
</code></pre>
<p>之会在当前目录下生成一个<code>tmp.svg</code>（这里如果我把活干完了，这里应该能正常显示）。</p>
<p><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" data-diagram-type="ACTIVITY" height="199px" preserveAspectRatio="none" style="width:181px;height:199px;background:#FFFFFF;" version="1.1" viewBox="0 0 181 199" width="181px" zoomAndPan="magnify"><defs/><g><ellipse cx="86.6993" cy="20" fill="#222222" rx="10" ry="10" style="stroke:#222222;stroke-width:1;"/><polygon fill="#F1F1F1" points="74.6993,50,98.6993,50,110.6993,62,98.6993,74,74.6993,74,62.6993,62,74.6993,50" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="22.4839" x="75.4574" y="66.4">legel</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="6.952" x="55.7474" y="59.8">T</text><rect fill="#F1F1F1" height="34.4001" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="61.4003" x="11" y="84"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="41.4003" x="21" y="106.0001">process</text><rect fill="#F1F1F1" height="34.4001" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="78.5964" x="92.4003" y="84"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="58.5964" x="102.4003" y="106.0001">report error</text><polygon fill="#F1F1F1" points="86.6993,124.4001,98.6993,136.4001,86.6993,148.4001,74.6993,136.4001,86.6993,124.4001" style="stroke:#181818;stroke-width:0.5;"/><ellipse cx="86.6993" cy="178.4001" fill="none" rx="10" ry="10" style="stroke:#222222;stroke-width:1.5;"/><line style="stroke:#222222;stroke-width:2.5;" x1="80.5121" x2="92.8865" y1="172.2129" y2="184.5873"/><line style="stroke:#222222;stroke-width:2.5;" x1="92.8865" x2="80.5121" y1="172.2129" y2="184.5873"/><line style="stroke:#181818;stroke-width:1;" x1="62.6993" x2="41.7001" y1="62" y2="62"/><line style="stroke:#181818;stroke-width:1;" x1="41.7001" x2="41.7001" y1="62" y2="84"/><polygon fill="#181818" points="37.7001,74,41.7001,84,45.7001,74,41.7001,78" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="110.6993" x2="131.6985" y1="62" y2="62"/><line style="stroke:#181818;stroke-width:1;" x1="131.6985" x2="131.6985" y1="62" y2="84"/><polygon fill="#181818" points="127.6985,74,131.6985,84,135.6985,74,131.6985,78" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="41.7001" x2="41.7001" y1="118.4001" y2="136.4001"/><line style="stroke:#181818;stroke-width:1;" x1="41.7001" x2="74.6993" y1="136.4001" y2="136.4001"/><polygon fill="#181818" points="64.6993,132.4001,74.6993,136.4001,64.6993,140.4001,68.6993,136.4001" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="131.6985" x2="131.6985" y1="118.4001" y2="136.4001"/><line style="stroke:#181818;stroke-width:1;" x1="131.6985" x2="98.6993" y1="136.4001" y2="136.4001"/><polygon fill="#181818" points="108.6993,132.4001,98.6993,136.4001,108.6993,140.4001,104.6993,136.4001" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="86.6993" x2="86.6993" y1="30" y2="50"/><polygon fill="#181818" points="82.6993,40,86.6993,50,90.6993,40,86.6993,44" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="86.6993" x2="86.6993" y1="148.4001" y2="168.4001"/><polygon fill="#181818" points="82.6993,158.4001,86.6993,168.4001,90.6993,158.4001,86.6993,162.4001" style="stroke:#181818;stroke-width:1;"/><!--SRC=[Aov9B2hXoanJqCX9JK_DqLGeoKZDKz08qUHI00AhWgByvDJYOckkr9pYL8XGKMf1Vb69GcfHKNuHK3ml9JCDH080]--></g></svg>
<br></p>
<p>因为不想要把图片额外存储，所以会使用svg。初步设想总体流程如下。</p>
<p><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" data-diagram-type="ACTIVITY" height="152px" preserveAspectRatio="none" style="width:225px;height:152px;background:#FFFFFF;" version="1.1" viewBox="0 0 225 152" width="225px" zoomAndPan="magnify"><defs/><g><rect fill="none" height="130.6001" style="stroke:#000000;stroke-width:1.5;" width="203.4448" x="11" y="11"/><path d="M101.4618,11 L101.4618,20.7999 L91.4618,30.7999 L11,30.7999" fill="none" style="stroke:#000000;stroke-width:1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="80.4618" x="14" y="25.9999">转换plantuml</text><rect fill="#F1F1F1" height="34.4001" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="183.4448" x="21" y="40.7999"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="163.4448" x="31" y="62.8">开一个子进程用java转换为svg</text><rect fill="#F1F1F1" height="34.4001" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="124.6217" x="50.4116" y="95.2"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="104.6217" x="60.4116" y="117.2001">用svg替换掉代码块</text><line style="stroke:#181818;stroke-width:1;" x1="112.7224" x2="112.7224" y1="75.2" y2="95.2"/><polygon fill="#181818" points="108.7224,85.2,112.7224,95.2,116.7224,85.2,112.7224,89.2" style="stroke:#181818;stroke-width:1;"/><!--SRC=[Io_ABorGUB5tpRFUHGKvYNabfRav2jLSLa_tD3pP0KIhdgwTy6B_xEShkfzFMP6LM9O8KVfanwxYidHhBYkWA93nRFP-eE2pliudknS_Nz3uTEvqQwvQ0000]--></g></svg>
<br></p>
<p>但是这个步骤可以放在不同的阶段去做，比如说<code>md2html</code>是处理<code>markdown</code>的主要流程，按照不同的处理时机节点，可以分成三种。</p>
<p><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" data-diagram-type="ACTIVITY" height="728px" preserveAspectRatio="none" style="width:266px;height:728px;background:#FFFFFF;" version="1.1" viewBox="0 0 266 728" width="266px" zoomAndPan="magnify"><defs/><g><rect fill="none" height="210.6001" style="stroke:#000000;stroke-width:1.5;" width="109.8436" x="78.4018" y="11"/><path d="M131.4787,11 L131.4787,20.7999 L121.4787,30.7999 L78.4018,30.7999" fill="none" style="stroke:#000000;stroke-width:1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="43.077" x="81.4018" y="25.9999">前处理</text><ellipse cx="133.3236" cy="50.7999" fill="#222222" rx="10" ry="10" style="stroke:#222222;stroke-width:1;"/><rect fill="#F1F1F1" height="34.4001" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="88.9676" x="88.8398" y="80.7999"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="68.9676" x="98.8398" y="102.8">转换plantuml</text><rect fill="#F1F1F1" height="34.4001" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="89.8436" x="88.4018" y="135.2"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="69.8436" x="98.4018" y="157.2001">md2html处理</text><ellipse cx="133.3236" cy="199.6001" fill="none" rx="10" ry="10" style="stroke:#222222;stroke-width:1.5;"/><line style="stroke:#222222;stroke-width:2.5;" x1="127.1364" x2="139.5108" y1="193.4129" y2="205.7873"/><line style="stroke:#222222;stroke-width:2.5;" x1="139.5108" x2="127.1364" y1="193.4129" y2="205.7873"/><rect fill="none" height="265.0002" style="stroke:#000000;stroke-width:1.5;" width="244.6471" x="11" y="231.6001"/><path d="M64.077,231.6001 L64.077,241.4001 L54.077,251.4001 L11,251.4001" fill="none" style="stroke:#000000;stroke-width:1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="43.077" x="14" y="246.6001">处理时</text><ellipse cx="133.3236" cy="271.4001" fill="#222222" rx="10" ry="10" style="stroke:#222222;stroke-width:1;"/><rect fill="#F1F1F1" height="34.4001" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="114.4589" x="76.0941" y="301.4001"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="94.4589" x="86.0941" y="323.4001">md2html处理开始</text><rect fill="#F1F1F1" height="34.4001" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="224.6471" x="21" y="355.8002"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="204.6471" x="31" y="377.8002">魔改代码，处理代码块时转换plantuml</text><rect fill="#F1F1F1" height="34.4001" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="114.4589" x="76.0941" y="410.2003"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="94.4589" x="86.0941" y="432.2003">md2html处理结束</text><ellipse cx="133.3236" cy="474.6004" fill="none" rx="10" ry="10" style="stroke:#222222;stroke-width:1.5;"/><line style="stroke:#222222;stroke-width:2.5;" x1="127.1364" x2="139.5108" y1="468.4132" y2="480.7875"/><line style="stroke:#222222;stroke-width:2.5;" x1="139.5108" x2="127.1364" y1="468.4132" y2="480.7875"/><rect fill="none" height="210.6001" style="stroke:#000000;stroke-width:1.5;" width="223.5552" x="21.546" y="506.6004"/><path d="M74.623,506.6004 L74.623,516.4003 L64.623,526.4003 L21.546,526.4003" fill="none" style="stroke:#000000;stroke-width:1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="43.077" x="24.546" y="521.6003">后处理</text><ellipse cx="133.3236" cy="546.4003" fill="#222222" rx="10" ry="10" style="stroke:#222222;stroke-width:1;"/><rect fill="#F1F1F1" height="34.4001" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="89.8436" x="88.4018" y="576.4003"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="69.8436" x="98.4018" y="598.4004">md2html处理</text><rect fill="#F1F1F1" height="34.4001" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="203.5552" x="31.546" y="630.8004"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="183.5552" x="41.546" y="652.8005">转换code块language-plantuml的块</text><ellipse cx="133.3236" cy="695.2005" fill="none" rx="10" ry="10" style="stroke:#222222;stroke-width:1.5;"/><line style="stroke:#222222;stroke-width:2.5;" x1="127.1364" x2="139.5108" y1="689.0133" y2="701.3877"/><line style="stroke:#222222;stroke-width:2.5;" x1="139.5108" x2="127.1364" y1="689.0133" y2="701.3877"/><line style="stroke:#181818;stroke-width:1;" x1="133.3236" x2="133.3236" y1="60.7999" y2="80.7999"/><polygon fill="#181818" points="129.3236,70.7999,133.3236,80.7999,137.3236,70.7999,133.3236,74.7999" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="133.3236" x2="133.3236" y1="115.2" y2="135.2"/><polygon fill="#181818" points="129.3236,125.2,133.3236,135.2,137.3236,125.2,133.3236,129.2" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="133.3236" x2="133.3236" y1="169.6001" y2="189.6001"/><polygon fill="#181818" points="129.3236,179.6001,133.3236,189.6001,137.3236,179.6001,133.3236,183.6001" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="133.3236" x2="133.3236" y1="281.4001" y2="301.4001"/><polygon fill="#181818" points="129.3236,291.4001,133.3236,301.4001,137.3236,291.4001,133.3236,295.4001" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="133.3236" x2="133.3236" y1="335.8002" y2="355.8002"/><polygon fill="#181818" points="129.3236,345.8002,133.3236,355.8002,137.3236,345.8002,133.3236,349.8002" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="133.3236" x2="133.3236" y1="390.2003" y2="410.2003"/><polygon fill="#181818" points="129.3236,400.2003,133.3236,410.2003,137.3236,400.2003,133.3236,404.2003" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="133.3236" x2="133.3236" y1="444.6004" y2="464.6004"/><polygon fill="#181818" points="129.3236,454.6004,133.3236,464.6004,137.3236,454.6004,133.3236,458.6004" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="133.3236" x2="133.3236" y1="556.4003" y2="576.4003"/><polygon fill="#181818" points="129.3236,566.4003,133.3236,576.4003,137.3236,566.4003,133.3236,570.4003" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="133.3236" x2="133.3236" y1="610.8004" y2="630.8004"/><polygon fill="#181818" points="129.3236,620.8004,133.3236,630.8004,137.3236,620.8004,133.3236,624.8004" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="133.3236" x2="133.3236" y1="665.2005" y2="685.2005"/><polygon fill="#181818" points="129.3236,675.2005,133.3236,685.2005,137.3236,675.2005,133.3236,679.2005" style="stroke:#181818;stroke-width:1;"/><!--SRC=[Io_ABorGUDhP-tH9o_C9RGhLNCKbYKKbN5Olzgvvrhke82SnhwGqDyUQooetnIYZ93S7eiwQApKlXQkMYoiTeXyi-6pwDeH-5ELFzpGyNTuDDEJbsYdFfknyidlnymMDx_VqG6GXtATpfmCDm6_jyzsJdysTZsxvX3vqnwEv5UgPvFoKLA0jGBFJInFJKtLXjZoVrG8KXfeA0000]--></g></svg>
<br></p>
<p>第二种的修改难度是最大的，需要理解<code>md4c</code>的原理，修改解析回调函数代码。<code>md4c</code>是一套很高效、优雅的解析框架，读它代码的成本不低，后面可以研究一下，这里<a href="https://talk.commonmark.org/t/md4c-new-implementation-in-c/2302/4">有篇记录</a>可以作为原理参考，todolisting。</p>
<p>第三种，后处理依赖于解析框架，我已经见过有些解析工具会把codeblock包装成<code>li</code>，这下依赖关系就开始变得恶心了。</p>
<p>所以我决定采用第一种修改方式。</p>
<h2>A</h2>
<p>由于sapin还没对外开源，这里就不写patch了。我额外生成了一个可以单独执行的二进制，可以套在<code>md2html</code>之前做，下面是库的代码。</p>
<pre><code>// puml.h
#ifndef PUML_H
#define PUML_H
#ifdef __cplusplus
extern &quot;C&quot; {
#endif /* __cplusplus */

typedef struct {
    const char *input;
    size_t len;
} puml_input;

typedef void (*puml_out_fn)(void*, const char *buf, size_t buflen);

int puml2svg(
        const puml_input *,
        void *,
        puml_out_fn
);




#ifdef __cplusplus
}
#endif /* __cplusplus */
#endif /* PUML_H */
</code></pre>
<pre><code>// puml.c
#include &lt;stdlib.h&gt;
#include &lt;unistd.h&gt;
#include &lt;sys/wait.h&gt;
#include &lt;stdio.h&gt;
#include &lt;string.h&gt;

#include &quot;puml.h&quot;

#define MIN(a, b) ((a) &gt; (b)) ? (b) : (a)
#define PUML_START  &quot;```plantuml\n&quot;
#define PUML_END    &quot;```&quot;

enum puml_status {
    NORMAL,
    IN_PUML,
};

static int run_jar (
        const char *jar,
        const char *in,
        size_t ilen,
        void *out,
        puml_out_fn out_fn)
{
    int p2c[2];
    int c2p[2];
    if (pipe(p2c) &lt; 0) return 1;
    if (pipe(c2p) &lt; 0) return 1;
    pid_t pid = fork();
    if (pid == 0) {
        dup2(p2c[0], STDIN_FILENO);
        dup2(c2p[1], STDOUT_FILENO);

        close(p2c[0]);
        close(p2c[1]);
        close(c2p[0]);
        close(c2p[1]);

        execlp(&quot;java&quot;, &quot;java&quot;, &quot;-jar&quot;, jar, &quot;--pipe&quot;, &quot;--svg&quot;, NULL);
        _exit(1);
    } else if (pid &lt; 0) {
        return 1;
    }
    close(p2c[0]);
    close(c2p[1]);

    /* input */
    write(p2c[1], in, ilen);
    close(p2c[1]);

    /* output */
    char buf[4096];
    ssize_t n;
    while ((n = read(c2p[0], buf, sizeof(buf))) &gt; 0) {
        out_fn(out, buf, n);
    }
    char br[] = &quot;\n&lt;br&gt;\n&quot;;
    out_fn(out, br, strlen(br));
    if (n &lt; 0) {
        close(c2p[0]);
        printf(&quot;read jar stdout get n = %d\n&quot;, n);
        waitpid(pid, NULL, 0);
        return 1;
    }
    close(c2p[0]);
    waitpid(pid, NULL, 0);
    return 0;
}

static int judge_same (
        const char *l,
        size_t llen,
        const char *r,
        size_t rlen)
{
    if (llen != rlen) return 0;
    while (llen &gt; 0) {
        llen--;
        if (l[llen] != r[llen]) return 0;
    }
    return 1;
}

int puml2svg(
        const puml_input *input,
        void *output,
        puml_out_fn ouput_fn)
{
    const char *ptr = input-&gt;input;
    const char *optr = ptr;
    const char *in;
    const char *jar_path = getenv(&quot;PUML_JAR&quot;);
    size_t ilen = 0;
    size_t isize = 4096;
    enum puml_status status = NORMAL;
    int ret;
    if (!jar_path) {
        fprintf(stderr, &quot;need env 'PUML_JAR'\n&quot;);
        return 1;
    }
    while (ptr &lt; (input-&gt;input + input-&gt;len)) {
        if (*ptr == '\n' || (ptr + 1) == (input-&gt;input + input-&gt;len)) {
            size_t len = (ptr - optr + 1);
            if (status == NORMAL) {
                if (judge_same(optr, len, PUML_START, strlen(PUML_START))) {
                    in = ptr + 1;
                    status = IN_PUML;
                } else {
                    /* copy line to output */
                    ouput_fn(output, optr, len);
                }
            } else if (status == IN_PUML) {
                /* maybe last char is not \n */
                if (judge_same(optr, len - (*ptr == '\n'), PUML_END, strlen(PUML_END))) {
                    /* run jar with stdin &amp; copy jar's stdout buf to output */
                    ilen = optr - in;
                    ret = run_jar(jar_path, in, ilen, output, ouput_fn);
                    if (ret != 0) {
                        return ret;
                    }
                    status = NORMAL;
                }
            }
            optr = ptr + 1;
        }
        ptr++;
    }
    return 0;
}
</code></pre>
<pre><code>// main.c
#include &lt;stdlib.h&gt;
#include &lt;stdio.h&gt;
#include &lt;fcntl.h&gt;
#include &lt;unistd.h&gt;
#include &lt;string.h&gt;

#include &quot;puml.h&quot;

struct dync_out {
    size_t osize;
    size_t olen;
    char *out;
};

void out_fn (void *output, const char *buf, size_t buflen)
{
    struct dync_out *out = (struct dync_out *)output;
    if (buflen + out-&gt;olen &gt;= out-&gt;osize) {
        out-&gt;osize *= 2;
        char *tmp = realloc(out-&gt;out, out-&gt;osize);
        if (!tmp) {
            printf(&quot;vaild!!! realloc out failed\n&quot;);
            return;
        }
        out-&gt;out = tmp;
    }
    memcpy(out-&gt;out + out-&gt;olen, buf, buflen);
    out-&gt;olen += buflen;
}

int main (int argc, char *argv[])
{
    if (argc == 1) {
        return 1;
    }

    int fd = open(argv[1], O_RDONLY);

    size_t ilen = 0;
    size_t isize = 4096;
    char *in = malloc(isize);

    ssize_t n;

    while((n = read(fd, in, isize - ilen)) &gt; 0) {
        if (ilen + n &gt;= isize) {
            isize *= 2;
            char *tmp = realloc(in, isize);
            if (!tmp) {
                free(in);
                close(fd);
                printf(&quot;realloc failed!\n&quot;);
                return 1;
            }
            in = tmp;
        }
        ilen += n;
    }

    if (n &lt; 0) {
        printf(&quot;read failed!\n&quot;);
        close(fd);
        free(in);
        return 1;
    }

    puml_input input = { in, ilen };

    struct dync_out out;
    out.osize = 4096;
    out.olen = 0;
    out.out = malloc(out.osize);

    int ret = puml2svg(&amp;input, &amp;out, out_fn);
    for (int i = 0; i &lt; out.olen; i++) {
        putchar(out.out[i]);
    }

    close(fd);
    free(in);
    free(out.out);

    return ret;
}
</code></pre>
<blockquote>
<p>写了大概一个下午，用C写字符串处理真是痛苦，感觉写了一天的<code>realloc</code>。缺少对C语言的经验总结，还是要多练多记。</p>
<p>另外，java真的好慢啊，严重拖慢了sapin的解析速度。</p>
</blockquote>

<footer>
  <ul>
    <li class="left">&copy; 2025 paradoxskin.</li>
    <li><a href="/blog">blog</a></li>
    <li><a href="/archive">archive</a></li>
    <li><a href="/design">design</a></li>
    <li><a href="/rss">rss</a></li>
  </ul>
</footer>
<script src="/res/js/main.js" defer></script>
</body>
</html>